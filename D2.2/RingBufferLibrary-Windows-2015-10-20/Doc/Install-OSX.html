<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"/>
<title>Install and Test on OSX</title>
<style>
	h3 {color:green;}
	pre {
		background-color:lightgrey;
		border:1px solid grey;
		padding:10px;
		margin:30px;
	}
</style>
</head>
<body lang="EN-US">

<p>August 23, 2015</p>

<h1>Install and Test OSX Installation</h1>

<h2>Contents</h2>
<ul>
        <li><a href="#pre">Preamble</a></li>
	<li><a href="#install">Install</a></li>
	<li><a href="#actiview">Merging with ActiView or Other Existing Application</a></li>
        <li><a href="#synctest">RingBuffer_SyncTest Usage</a></li>
        <li><a href="#rebuild">Rebuilding the binary files</a></li>
        <li><a href="#develop">Develop a Program</a></li>
        <li><a href="#frame">ReCreate the Framework for use with LabVIEW or Other Program</a></li>
</ul>

<a name="pre"></a>
<h3>Preamble</h3>

<p>"RingBuffer" is the new name for the BioSemi library that was formerly called "Labview_DLL".
The new name was chosen to remove any inference that the library comes from or, is dependent on, the
National Instruments "LabVIEW" product.</p>

<p>This software contains no kernel mode routines and runs entirely
in user mode.
</p>

<p>The BioSemi Mac software is distributed here in both prebuilt binary
form - for Intel MAC OSX 10.10 (Yosemite) and later - and with a Makefile so that it
can be rebuild to run with updated components.</p>

<p>The low level software needed to access the USB sample
stream generated by the BioSemi acquisition hardware consists of 2 libraries:
<ul>
<li>1. "libusb-1.0" to control of the USB device
(<a href="http://sourceforge.net/projects/libusb">
	http://sourceforge.net/projects/libusb</a>).<br>
The "libusb-1.0" package has the "GNU Lesser General Public License"
(or "LGPL") which means it must be distributed in source form.
</li>
<br>
<li>2. "libRingBuffer" to control the continuous filling of a sample
ring buffer.</li>
</ul>
</p>

<p>Prebuild binary files are located in the "OSX32" and
"OSX64" subdirectories.  The first set of instructions below give
the steps required to use these pre-built binary files, see
<a href="#install">Install</a>.</p>

<p>If these binary files don't work, try rebuilding them from the
available source, see
<a href="#rebuild">Rebuilding the binary files</a>.</p>

<a name="install"></a>
<h3>Install</h3>

<ul>
	<li>1. Move to the appropriate subdirectory,<br>
	<ul>
		<li>for 32 bit software:  cd OSX32</li>
		<li>for 64 bit software:  cd OSX64</li>
	</ul>

	<p> 
	The choice should be determined by the bit-width of the acquisition
	application you intend to run.  The "file" command can be used to
	determine a program's bit-width.
	</p>

<p>Warning: don't install both 64 bit and 32 bit software in the same
   login session.  The install procedure appends to paths defined in the
   environment.  Serially appending both 64 and 32 bit items to the same
   environment variables will cause confusion.</p>

	<p>The directories contains these binary files:</p>
	<ul>
		<li>RingBuffer_SyncTest<br>
   This is a test program that acquires data from the BioSemi receiver and
   checks the data format.</li>
   <br>
   <li>libRingBuffer.0.0.1.dylib<br>
   This is the BioSemi shared library that controls the ring buffer.</li>
   <br>
   <li>libusb-1.0.0.dylib<br>
   This is the shared library that controls the computer's usb interface and
   that the BioSemi shared library uses to fill the ring buffer.</li>
   <br>

   <li>BioSemi-RingBuffer.framework<br>
   This is a Mac OSX data structure that contains everything needed by National
   Instruments LabVIEW to enable it acquire data from the BioSemi receiver.  It
   contains copies of the two shared libraries mentioned above ("libRingBuffer"
   and "libusb-1.0".</li>
   <br>

   <li>ringbuffer.ini<br>
   This is a sample parameter file used by libRingBuffer.</li>
   <br>
   </ul>
   </li>

   <li>2. Add the current directory to the environment variable
   DYLD_LIBRARY_PATH by using this command:
<pre>
export DYLD_LIBRARY_PATH=`pwd`:$DYLD_LIBRARY_PATH
</pre>
</li>

   <li>3. Plug the Biosemi Receiver's USB cable into the computer and type
<pre>
./RingBuffer_SyncTest 0
</pre>
   to start the test program.  Use CTRL-C to stop the test.  See the
<a href="#synctest">RingBuffer_SyncTest Usage</a>
   section below for more information about this program.<br>
   <p>If you get this message:<br>
<pre>
dyld: Library not loaded: libRingBuffer.0.0.1.dylib
Referenced from: /Users/ ... /RingBuffer_SyncTest
Reason: image not found
</pre>
   this usually means that the DYLD_LIBRARY_PATH is not set correctly.
   </p></li>
   </ul>

<p>A more permanent arrangement for the libRingBuffer and libusb
shared libraries is to put them
in /usr/local/lib.
This removes the need to have to repeatedly setup the DYLD_LIBRARY_PATH
environment variable to be able to find these shared libraries.</p>

<p>Once this test program works, follow the instructions in
<a href="TryClientServer.html" target=_blank">Try Client/Server</a>
if you want to try the client/server mode of operation.
</p>

<p>Some performance improvement may be gained by using the library
parameters explained at
<a href="Tuning.html" target=_blank">Tuning</a>.</p>

<a name="actiview"></a>
<h3>Merging with ActiView or Other Existing Application</h3>

<ul>
<li>If you are running the stand alone <em>ActiView</em> Application,
the "BioSemi-RingBuffer.framework" is built into the Application and cannot
be replaced.  A new version of the Application must be created using the
National Instruments Application Builder tool.</li>
<br>
<li>If you are running the National Instruments LabVIEW Workbench and using
<em>ActiView</em> vi's, replace the "BioSemiRingBuffer32.framework" (or 64)
with the version from this distribution.</li>
<br>
<li>For other existing applications,
replace the "libRingBuffer" with the version from this distribution.<br>
Be careful to use the library version with the bit-width that matches
the program.<br>  The "file" command can be used to determine a program's
bit-width.</li>
<br>
<li>Insert the parameter file <em>ringbuffer.ini</em>
from this distribution into either the directory containing the
application file or, if using the LabVIEW Workbench,
your home directory.</li>
<br>
<li>To handle the library rename transition:<br>
<br>
<ul>
<li>If the application requires "liblabview_dll", copy and rename "libRingBuffer"
as "liblabview_dll".</li>
<br>
<li>If the application requires "BioSemi-Labview_DLL.framework", renaming
the finished framework doesn't seem to work.  An equivalent 32 bit framework
using new code with the old name is included in this download package.  However
new applications should use the framework with the new name. 
</li>
</ul>
</ul>

<a name="synctest"></a>
<h3>RingBuffer_SyncTest Usage</h3>

<p>This program checks that the 0xffffff00 sync words appear in all the
right places in the input stream.  It stops with a message if they don't.</p>

<p>There can be 3 command line parameters for this program:<br>
<ul>
	<li>Ring buffer size, in 512 byte units.<br>
Ring buffer size must start with a 'b' or 'B' and is expressed in units
of 512 bytes.  The default if not given is b65536 for 32 Mbytes.
	</li>
<br>
        <li>Range of channels to request from a remote sample server.<br>
The range of channels to request from a remote sample server must have a 'r'
or 'R' prefix and be two numbers separated by a '-'.  The default is all
sampled channels.  Note: the sync and status channels are always added.
</li>
<br>
	<li>Time to run.<br>
The time to run is in seconds.  The default if not given is 600 seconds
(10 minutes).  If given as 0 there will be no time limit.
	</li>
</ul>
These parameters can be in any order or left out completely.</p>

<p>Hitting CTRL-C when the program is running will stop the run.</p>

<a name="rebuild"></a>
<h3>Rebuilding the binary files</h3>

<p>To rebuild the binary files Apple's program development
package "Xcode Tools" must be installed.  This package can be downloaded through the
internet from the App Store.</p>
<p>Then perform the following steps to build first the libusb-1.0 library
and then the <em>RingBuffer</em> library. In these instructions the bash
shell is assumed.</p>
<ul>
	<li>1. This download includes the current (May 2015) "libusb-1.0.19" source distribution as
   a convenience for installation.  The libsub software is identical to that available
   on the sourceforge web site.</li>
<br>
   <li>2. Move to the appropriate subdirectory,
   <ul>
	   <li>for 32 bit software: cd OSX32</li>
	   <li>for 64 bit software: cd OSX64</li>
   </ul>
   </li>
<br>
<li>3. Type 
<pre> 
. ./compile_libusb.sh
</pre>
</li>
<br>

   <li>4. Add the location of "libusb"'s lib subdirectory to the
   environment variable DYLD_LIBRARY_PATH, i.e.
<pre>
export DYLD_LIBRARY_PATH=$LIBUSB_PREFIX/lib:$DYLD_LIBRARY_PATH
</pre>
   </li>
<br>
   <li>5. Type "make" to build library "libRingBuffer" and a test program
   "RingBuffer_SyncTest" that uses this library for data acquisition.<br>
   <br>
   Note: The shared library is called "RingBuffer.dll" in the version of this
         software that runs on Windows.
         To follow OSX naming conventions the file produced here is
         actually called "libRingBuffer.0.0.1.dylib", and a "linker name"
         "libRingBuffer.dylib" is setup to point to this file.
	 </li>
<br>
	 <li>6. To run the test program, the location of the "libRingBuffer" shared
   library must be added to the environment variable DYLD_LIBRARY_PATH.
   If it is the current directory, this is the command:
<pre>
export DYLD_LIBRARY_PATH=`pwd`:$DYLD_LIBRARY_PATH
</pre>
   As well, the location of the "libusb" shared library must be
   declared - as in step 4 above.  If you just performed this step then
   this has been taken care of. Otherwise, use
<pre>
export DYLD_LIBRARY_PATH=`pwd`/lib:$DYLD_LIBRARY_PATH
</pre>
   Plug the Biosemi Receiver's USB cable into the computer and type
   <pre>
   ./RingBuffer_SyncTest 0
</pre>
to start the test program.  Use CTRL-C to
stop the test.  See the
<a href="#synctest">RingBuffer_SyncTest Usage</a>
section for more about this program.<br>
   <br>
   If you get this message:
   <pre>
dyld: Library not loaded: libRingBuffer.0.0.1.dylib
Referenced from: /Users/ ... /RingBuffer_SyncTest
Reason: image not found
</pre>
   this usually means that the DYLD_LIBRARY_PATH is not set correctly.
   </li>
<br>
   <li>7. A more permanent arrangement for the libRingBuffer and libusb
   shared libraries is to put them
   in /usr/local/lib.

   This removes the need to have to repeatedly setup the DYLD_LIBRARY_PATH environment
   variable to be able to find these shared libraries.
   </li>
   <br>
   <li>8. To use these new binary files with <em>ActiView</em>, they must be put
   into a Framework.  To do this follow these steps:
<a href="#frame">ReCreate the Framework</a>
	</li>
   </ul>


<a name="develop"></a>
<h3>Develop a Program</h3>

<p>To develop your own acquisition program using the <em>RingBuffer</em> library,
see
<a href="RingBufferLibrary-API.html" target=_blank">RingBufferLibrary-API</a> for a description
of the API's available.</p>

<p>The distributed software was compiled and tested in both 32 and 64 bit
modes using an Intel based MAC running OSX 10.10.5 (Yosemite).
The Xcode compiler on this system is version 6.4.</p>

<a name="frame"></a>
<h3>ReCreate the Framework for use with LabVIEW or Other Program</h3>

<p>LabVIEW for OSX requires user Call Libraries be in a framework.
National Instruments' latest instructions for creating such a framework are given at:</p>
<pre>
<a href="http://digital.ni.com/public.nsf/allkb/A6A6371FE0EA333B86257015005E3400">http://digital.ni.com/public.nsf/allkb/A6A6371FE0EA333B86257015005E3400</a>
</pre>
<p>These instructions are reproduced below:
<pre>
1. Open Xcode.
2. Select File » New Project.
3. Select the Framework & Library » Cocoa Framework template.

Note: LabVIEW supports the use of Frameworks that use the Carbon API, and does not support
Frameworks that use the Cocoa API. However, since the Carbon Framework template has been
deprecated in current versions of Xcode, you can use the Cocoa Framework template to start
the project. 

Again, Frameworks called by LabVIEW should not call the Cocoa API on Mac OS X. LabVIEW does
not use Cocoa, and therefore does not initialize this API. Using this API inside Frameworks
may result in unpredictable behavior.

4. Name the framework when prompted (e.g. MyFramework). Click Next.
5. Specify the location of the project on disk. Click Create. 
6. Make sure that the project is set to build a 32-bit or 32/64-bit Universal Framework. LabVIEW
for Mac OS X cannot load 64-bit frameworks. Within the Project Navigator select the Project
item in the tree (e.g. MyFramework), select the Project in the Settings area, and select the
Build Settings tab.
Make sure that the selected build architecture is 32-bit or standard (32/64-bit Intel).
</pre>
</p>

<p>For our purpose, use this variation to these instructions:<br>

<ul>
	<li>Perform steps 1-3.</li>
	<li>In step 4, name the project "BioSemiRingBuffer32" (or "BioSemiRingBuffer64").</li>
	<li>In step 6, under "Build Settings", "All", make sure "Architecture" is set to
"32-bit Intel (i386)" or "64-bit Intel (x86_64).</li>
<li>If building for 32 bits, set "Base SDK" and "OSX Deployment Target" to "10.9".</li>
<li>Under Product->Scheme->Edit Scheme, Section Info, set "Build Configuration" to "Release"
 and Close the Scheme.</li>
<li>In the center panel, remove the second target "BioSemiRingBuffer32Tests" (or 64).
<li>Add copies of existing files to the project.<br>
Be careful to choose the correct versions of the .o and .dylib files, 32 or 64 bits.<br>
Choose the option to copy these files into the Xcode work directory.<br>
<br>
<ul>
<li>In the left panel, right-click the file list section name and choose the "Add Files to ..."
option to add these files: 
	<pre>
bsif.h
bsif_inject_socket_samples.o
bsif_libusb.o
bsif_socket_io.o
bsif_tap_usb_samples.o
ringbuffer.cpp
ringbuffer.h
</pre>
</li>
<li>In the left panel, right-click the "Supporting Files" section name and choose again the
"Add Files to ..." option for this file:
	<pre>
libusb-1.0.0.dylib
</pre>
</li>
<li>In the center panel, under"Targets", click the target's name.</li>
<li>Under "Build Phases", "Copy Bundle Resources", use the "+" sign and add
"libusb-1.0.0.dylib".</li>
<li>Under "Product", choose "Clean" and then "Build".</li>
</ul>
</p>
</ul>
<p>Outside of Xcode, copy the newly created framework to the directory
where you intend to use it.  Rename it at this stage if necessary.
</p>
<p>Do this to make the framework portable so it can be used on other similar computers
(replace the 32's with 64's if building a 64 bit version):<br>
<ul>
        <li>1. cd to the "BioSemiRingBuffer32.framework/Versions/Current" subdirectory.</li>

        <li>2. View the framework's absolute location dependancy for libusb using this command:<br>
        <pre>
otool -L BioSemiRingBuffer32
</pre>
        </li>
       <li>3. Make this a relative location dependancy by using the following command,
        replacing the "XXX" with the specific directory being used:<br>
        <pre>
install_name_tool -change /Users/XXX/lib/libusb-1.0.0.dylib @loader_path/Resources/libusb-1.0.0.dylib BioSemiRingBuffer32
</pre>
        </li>
        <li>4. Check this dependancy change by repeating the command:<br>
        <pre>
otool -L BioSemiRingBuffer32 
</pre>
        </li>
</ul>

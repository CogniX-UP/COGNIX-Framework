<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"/>
<title>What's new in the 2015 Ring Buffer Library</title>
<style>
	h3 {color:green;}
</style>
</head>
<body lang="EN-US">

<p>Sept. 15, 2015</p>

<h1>What's New In the 2015 Ring Buffer Library</h1>

<h2>Contents</h2>
<ul>
	<li><a href="#new">What's new</a></li>
<ul>
	<li><a href="#requirement">The Requirement</a></li>
	<li><a href="#solution">The Solution</a></li>
	<li><a href="#result">The Result</a></li>
</ul>
	<li><a href="#install">Install</a></li>
	<li><a href="#try">Try Client/Server</a></li>
	<li><a href="#develop">Develop a Program</a></li>
</ul>

<a name="new"></a>
<h3>What's new</h3>

<p>"RingBuffer" is the new name for the BioSemi library that was formerly called "Labview_DLL".
The new name was chosen to remove any inference that the library comes from or, is dependent on, the
National Instruments "LabVIEW" product.</p>

<p>The most important new feature in <em>RingBuffer</em> library 2015 is support for remote
access to the Usb sample stream.</p>

<p>While continuing to support all previous (i.e. Labview_DLL) API calls, the 2015 version of the
library has the ability to stream samples from the Usb ring buffer through a Tcp socket
to a client program.</p>
<p>Streaming is initiated by a client program and is handled on the server
entirely by the library.  No participation by the server application itself
is required other than to maintain the flow of samples from the Usb interface into the
ring buffer.</p>

<p>The impetus for this change was to give tablets and smartphones the ability to
tap into acquisition sessions running on Windows, Linux or OSX systems for remote
signal monitoring or data analysis.</p>

<a name="requirement"></a>
<h4>The Requirement</h4>

<p>To be useful four changes were seen as desireable:
<ul>

<li>The streaming service should require no change to existing applications.<br>
<br>
Since most applications running an acquisition use the
<em>RingBuffer</em> (formerly <em>Labview_DLL</em>) library to control sample input,
the streaming service could be implemented entirely in this library.  Placed there it
could be transparent to the application running the acquisition.  The library would
need only to define a Tcp "listen_port" port that would be monitored for streaming
service requests.</li>
<br>

<li>The remote client should be able to dynamically choose what is streamed.<br>
<br>
Since the server application itself is not providing the streaming service,
the client would have to have full control over what is streamed.
</li>
<br>

<li>The client should be able to detect
data overrun and other transmission problems.<br>
<br>
To detect synchronization problems the existing sync and status words that preceed every
set of Usb samples should be part of the transmission.  This requirement re-inforces the
need for the next requirement - transmitting multiple channels.  The stream server should
also alert the client if the new sample insertion
point in the ring buffer laps the stream output point.  This happens when samples cannot
be streamed as quickly as new samples arrive from the Usb.
</li>
<br>

<li>The ability to transmit multiple channels simultaneously should be possible.<br>
<br>
Having multiple simultaneous channels would allow for more ambitious
signal monitoring and/or data analysis.
</li>
</ul>
</p>
<a name="solution"></a>
<h4>The Solution</h4>

<p>To implement these items, the following changes were made in the <em>RingBuffer</em>
library:
<ul>
<li>When READ_MULTIPLE_SWEEPS is called, a thread is created to perform the streaming
operation.</li>
<br>
<li>Once Usb sampling has started, the thread listens on the Tcp "listen_port" for a
client connection request.</li>
<br>
<li>When a connection request arrives, the server replies with 2 items:<br>

<ul>
<li>The number of channels being sampled.</li>
<li>The approximate rate the Usb buffer is being filled, in samples per
channel per second.  This is a close approximation to the actual sampling
rate.</li>
</ul>
</li>
<br>
<li>The client is expected to reply with channel numbers or ranges of channel numbers
wanted.</li>
<br>
<li>The server selects a starting point in its ring buffer (i.e. on a sync/status
word boundary) and starts the streaming operation.  Samples for the channels requested
are packed into an output buffer, compressed and transmitted.  This selection,
compression and transmission repeats continuously as long as new samples become
available and the client connected is not closed.</li>
<br>
<li>If the client closes the Tcp connection, the streaming thread resumes waiting for
a new connection and new set of channel numbers.</li>
<br>
<li>If the stream server finds that it can't stream samples as fast as new samples
arrive, the server will close the connection.  The client can immediately re-connect
to re-sync with the interrupted transmission but will have missed some channel sets.</li>
</ul>

<a name="result"></a>
<h4>The Result</h4>

<p>Two methods were used to test and to illustrate the use of this new feature:<br>
<ul>
	<li>An Android App, <em>BSChannelViewer</em>, was written as a stream client
	and is included in this download package.
	<p>The App plots sample traces from any channel being sampled on the server on demand.
	The client re-syncs as necessary whenever internet bandwidth is low.</p>
</li>
<li>Changes were made to the <em>RingBuffer</em> library itself to enable it to act as a stream client
as well as a stream server.
<p>When used as a stream client, the ring buffer is filled with samples from a Tcp socket
instead of a Usb interface.  This change allows most existing Usb acquisition applications
(e.g. <em>ActiView</em>) to be used without modification
as remote Tcp acquisition clients.</p>

<p>The mode, client or server,  is determined when the application calls "OPEN_DRIVER". If
no unclaimed BioSemi Usb Receiver is found and if an IP address for a potential sample server
has been declared in the <em>ringbuffer.ini</em> file,
an attempt is made to connect via a Tcp socket to that server's address before declaring
an "open failure".</p>
<p>The client and server programs can be running on the same or different computers.</p>
</li>
</ul>

<a name="install"></a>
<h3>Install</h3>

<p>For a first time install on a Windows computer see
<a href="Doc/Install-Windows.html" target=_blank">Install-Windows</a>
.</p>

<p>To update an existing Windows installation (e.g. <em>ActiView</em>
or other program),
replace all previous <em>RingBuffer.dll</em> (or <em>Labview_DLL.dll</em>)
library files with the new version.  If using an application that requires
the <em>Labview_DLL.dll</em> library, copy and rename the
<em>RingBuffer.dll</em> file and use that instead.  Be careful to use the
bit-width library file that matches the application's bit-width.</p>

<p>The <em>Merging with ActiView or Other Existing Program</em> section of  
<a href="Doc/Install-Windows.html" target=_blank">Install-Windows</a>
describes in more detail how to prepare an existing program for use with
the new <em>RingBuffer</em> library.
</p>


<p>For a first time install on a Linux computer see
<a href="Doc/Install-Linux.html" target=_blank">Install-Linux</a>.</p>

<p>To update an existing Linux installation (e.g. an <em>ActiView</em>
or other program), replace all previous <em>libRingBuffer</em> (or
<em>liblabview_dll</em>) and <em>libusb-1.0</em> library files with the
new versions.  If using an application that requires the
<em>liblabview_dll</em> library, copy and rename the <em>libRingBuffer</em>
file and use that instead.  Be careful to use bit-width library files
that match the application's bit-width.  The "file" command can be used
to determine a program's bit-width.
</p>

<p>The <em>Merging with ActiView or Other Existing Application</em> section of  
<a href="Doc/Install-Linux.html" target=_blank">Install-Linux</a>
describes in more detail how to prepare an existing program for use with the new
<em>RingBuffer</em> library.</p>

<p>For a first time install on an OSX computer see
<a href="Doc/Install-OSX.html" target=_blank">Install-OSX</a>.</p>

<p>To update an existing OSX installation (e.g. an <em>ActiView</em>
or other program), replace
all previous <em>libRingBuffer</em> (or <em>liblabview_dll</em>),
<em>libusb</em> library files and <em>BioSemi-Ringbuffer</em> (or
<em>BioSemi-Labview_DLL</em>) framework files with the new versions.
If using an application that requires the <em>liblabview_dll</em>
library, copy and rename the <em>libRingBuffer</em> file and use that instead.
Be careful to use bit-width files that match the application's bit-width.
The "file" command can be used to determine a program's bit-width.
If you use the OSX
ActiView Application itself (not the .vi's) to run, the National Instruments
LabVIEW Application Builder must be used to update the Application - individual
components cannot be updated.
</p>

<p>The <em>Merging with ActiView or Other Existing Application</em> section of  
<a href="Doc/Install-OSX.html" target=_blank">Install-OSX</a>
describes in more detail how to prepare an existing program for use with the new
<em>RingBuffer</em> library.</p>

<a name="try"></a>
<h3>Try Client/Server</h3>

<p>For step-by-step instructions, see
<a href="Doc/TryClientServer.html" target=_blank">Try Client/Server</a>.</p>

<a name="develop"></a>
<h3>Develop a Program</h3>

<p>To develop your own client or server program using the <em>RingBuffer</em> library,
see
<a href="Doc/RingBufferLibrary-API.html" target=_blank">RingBufferLibrary-API</a> for a description
of the API's available.</p>

<p>
To develop a client program without using the <em>RingBuffer</em> library
to receive samples (e.g. as a tablet or smartphone App), see
<a href="Doc/RingBufferLibrary-TransferProtocol.html" target=_blank">RingBufferLibrary-TransferProtocol</a>
for a description of the Tcp transfer protocol used.
</p>

</body>
</html>
